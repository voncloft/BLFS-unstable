# description   : D-Bus is a message bus system, a simple way for applications to talk to one another
# depends       : xorglibraries

name=dbus
version=1.16.2    
release=1
source="https://dbus.freedesktop.org/releases/dbus/dbus-$version.tar.xz"

options="!checksum"

build() {
    cd $name-$version
    
    mkdir build 
    cd    build 
    meson setup --prefix=/usr          \
    --buildtype=release    \
    --wrap-mode=nofallback \
    -D systemd=disabled    \
    .. 
    ninja
    meson configure -D asserts=true -D intrusive_tests=true 
    DESTDIR=$PKG ninja test
    /etc/init.d/dbus start
    DESTDIR=$PKG ninja install
    chown -v root:messagebus /usr/libexec/dbus-daemon-launch-helper 
    chmod -v      4750       /usr/libexec/dbus-daemon-launch-helper
    dbus-uuidgen --ensure
    ln -sfv /var/lib/dbus/machine-id /etc
    if [ -e /usr/share/doc/dbus ]; then
    rm -rf /usr/share/doc/dbus-$version    
    mv -v  /usr/share/doc/dbus{,-$version}
    fi
cat > $PKG/etc/dbus-1/session-local.conf << "EOF"
    <!DOCTYPE busconfig PUBLIC
    "-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"
    "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">
    <busconfig>
    <!-- Search for .service files in /usr/local -->
    <servicedir>/usr/local/share/dbus-1/services</servicedir>
    </busconfig>
EOF
    make DESTDIR=$PKG install-dbus
}
