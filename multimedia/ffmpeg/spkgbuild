# description   : FFmpeg is a solution to record, convert and stream audio and video
# depends       : libaom libass fdkaac freetype lame libvorbis libvpx opus x264 x265 nasm yasm alsalib libva sdl2 libvdpau libvdpauvagl

name=ffmpeg
version=7.1.1    
release=1
source="https://ffmpeg.org/releases/ffmpeg-$version.tar.xz
https://www.linuxfromscratch.org/patches/blfs/svn/ffmpeg-$version-chromium_method-1.patch"

options="!checksum"

build() {
    cd $name-$version
    
    patch -Np1 -i ../ffmpeg-$version-chromium_method-1.patch
    ./configure --prefix=/usr        \
    --enable-gpl         \
    --enable-version3    \
    --enable-nonfree     \
    --disable-static     \
    --enable-shared      \
    --disable-debug      \
    --enable-libaom      \
    --enable-libass      \
    --enable-libfdk-aac  \
    --enable-libfreetype \
    --enable-libmp3lame  \
    --enable-libopus     \
    --enable-libvorbis   \
    --enable-libvpx      \
    --enable-libx264     \
    --enable-libx265     \
    --enable-openssl     \
    --ignore-tests=enhanced-flv-av1 \
    --docdir=/usr/share/doc/ffmpeg-$version 
    make DESTDIR=$PKG 
    gcc tools/qt-faststart.c -o tools/qt-faststart
    pushd doc 
    for DOCNAME in `basename -s .html *.html`
    do
    texi2pdf -b $DOCNAME.texi 
    texi2dvi -b $DOCNAME.texi 
    dvips    -o $DOCNAME.ps   \
    $DOCNAME.dvi
    done 
    popd 
    unset DOCNAME
    doxygen doc/Doxyfile
    make DESTDIR=$PKG fate-rsync SAMPLES=fate-suite/
    rsync -vrltLW  --delete --timeout=60 --contimeout=60 \
    rsync://fate-suite.ffmpeg.org/fate-suite/ fate-suite/
    make DESTDIR=$PKG fate THREADS=
    SAMPLES=fate-suite/ | tee ../fate.log 
    grep ^TEST ../fate.log | wc -l
    make DESTDIR=$PKG install 
    install -v -m755    tools/qt-faststart /usr/bin 
    install -v -m755 -d           /usr/share/doc/ffmpeg-$version 
    install -v -m644    doc/*.txt /usr/share/doc/ffmpeg-$version
    install -v -m644 doc/*.pdf /usr/share/doc/ffmpeg-$version 
    install -v -m644 doc/*.ps  /usr/share/doc/ffmpeg-$version
    install -v -m755 -d /usr/share/doc/ffmpeg-$version/api                     
    cp -vr doc/doxy/html/* /usr/share/doc/ffmpeg-$version/api                  
    find /usr/share/doc/ffmpeg-$version/api -type f -exec chmod -c 0644 \{} \; 
    find /usr/share/doc/ffmpeg-$version/api -type d -exec chmod -c 0755 \{} \;
}
