# description   : Public Key Infrastructure (PKI) is a method to validate the authenticity of an otherwise unknown entity across untrusted networks
# depends       : p11kit libtasn1

name=make-ca
version=1.16.1    
release=1
source="https://github.com/lfs-book/make-ca/archive/v$version/make-ca-$version.tar.gz"

options="!checksum"

build() {
    cd $name-$version
    
cat > $PKG/etc/cron.weekly/update-pki.sh << "EOF" 
EOF
    chmod 754 /etc/cron.weekly/update-pki.sh
    wget http://www.cacert.org/certs/root.crt 
    wget http://www.cacert.org/certs/class3.crt 
    openssl x509 -in root.crt -text -fingerprint -setalias "CAcert Class 1 root" \
    -addtrust serverAuth -addtrust emailProtection -addtrust codeSigning \
    > /etc/ssl/local/CAcert_Class_1_root.pem 
    openssl x509 -in class3.crt -text -fingerprint -setalias "CAcert Class 3 root" \
    -addtrust serverAuth -addtrust emailProtection -addtrust codeSigning \
    > /etc/ssl/local/CAcert_Class_3_root.pem 
    /usr/sbin/make-ca -r
    openssl x509 -in /etc/ssl/certs/Makebelieve_CA_Root.pem \
    -text \
    -fingerprint \
    -setalias "Disabled Makebelieve CA Root" \
    -addreject serverAuth \
    -addreject emailProtection \
    -addreject codeSigning \
    > /etc/ssl/local/Disabled_Makebelieve_CA_Root.pem 
    /usr/sbin/make-ca -r
    export _PIP_STANDALONE_CERT=/etc/pki/tls/certs/ca-bundle.crt
    make DESTDIR=$PKG install 
    install -vdm755 /etc/ssl/local
    /usr/sbin/make-ca -g
    mkdir -pv /etc/profile.d 
cat > $PKG/etc/profile.d/pythoncerts.sh << "EOF"
    # Begin /etc/profile.d/pythoncerts.sh
    export _PIP_STANDALONE_CERT=/etc/pki/tls/certs/ca-bundle.crt
    # End /etc/profile.d/pythoncerts.sh
EOF
}
