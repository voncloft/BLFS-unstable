# description   : The lightdm package contains a lightweight display manager based upon GTK
# depends       : exo libgcrypt itstool linuxpam xorgserver glib libxklavier vala

name=lightdm
version=1.32.0    
release=1
source="https://github.com/CanonicalLtd/lightdm/releases/download/$version/lightdm-$version.tar.xz
https://github.com/Xubuntu/lightdm-gtk-greeter/releases/download/lightdm-gtk-greeter-2.0.9/lightdm-gtk-greeter-2.0.9.tar.gz"

options="!checksum"

build() {
    cd $name-$version
    
    sed -i s/systemd/elogind/ data/pam/*
    ./configure --prefix=/usr                 \
    --libexecdir=/usr/lib/lightdm \
    --localstatedir=/var          \
    --sbindir=/usr/bin            \
    --sysconfdir=/etc             \
    --disable-static              \
    --disable-tests               \
    --with-greeter-user=lightdm   \
    --with-greeter-session=lightdm-gtk-greeter \
    --docdir=/usr/share/doc/lightdm-$version 
    make
    tar -xf ../lightdm-gtk-greeter-2.0.9.tar.gz 
    cd lightdm-gtk-greeter-2.0.9 
    ./configure --prefix=/usr                 \
    --libexecdir=/usr/lib/lightdm \
    --sbindir=/usr/bin            \
    --sysconfdir=/etc             \
    --with-libxklavier            \
    --enable-kill-on-sigterm      \
    --disable-libido              \
    --disable-libindicator        \
    --disable-static              \
    --disable-maintainer-mode     \
    --docdir=/usr/share/doc/lightdm-gtk-greeter-2.0.9 
    make
    ln -sf /opt/xorg/bin/Xorg /usr/bin/X
    telinit 5
    groupadd -g 65 lightdm       
    useradd  -c "Lightdm Daemon" \
    -d /var/lib/lightdm \
    -u 65 -g lightdm    \
    -s /bin/false lightdm
    make DESTDIR=$PKG install                                                  
    cp tests/src/lightdm-session /usr/bin                         
    sed -i '1 s/sh/bash --login/' /usr/bin/lightdm-session        
    rm -rf /etc/init                                              
    install -v -dm755 -o lightdm -g lightdm /var/lib/lightdm      
    install -v -dm755 -o lightdm -g lightdm /var/lib/lightdm-data 
    install -v -dm755 -o lightdm -g lightdm /var/cache/lightdm    
    install -v -dm770 -o lightdm -g lightdm /var/log/lightdm
    make DESTDIR=$PKG install
    make DESTDIR=$PKG install-lightdm
}
