# description   : Mesa is an OpenGL compatible 3D graphics library
# depends       : xorg libraries libdrm mako pyyaml

name=mesa
version=25.1.3    
release=1
source="https://mesa.freedesktop.org/archive/mesa-$version.tar.xz
https://www.linuxfromscratch.org/patches/blfs/svn/mesa-add_xdemos-4.patch"

options="!checksum"

build() {
    cd $name-$version
    
    lspci | grep VGA
    patch -Np1 -i ../mesa-add_xdemos-4.patch
    mkdir build 
    cd    build 
    meson setup ..                 \
    --prefix=$XORG_PREFIX    \
    --buildtype=release      \
    -D platforms=x11,wayland \
    -D gallium-drivers=auto  \
    -D vulkan-drivers=auto   \
    -D valgrind=disabled     \
    -D video-codecs=all      \
    -D libunwind=disabled    
    ninja
    meson configure -D build-tests=true 
    sed '/float rsqrtf/,/^}/d' \
    -i ../src/gallium/drivers/llvmpipe/lp_test_arit.c 
    DESTDIR=$PKG ninja test
    DESTDIR=$PKG ninja install
    cp -rv ../docs -T /usr/share/doc/mesa-$version
}
