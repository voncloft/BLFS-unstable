# description   : Dovecot is an Internet Message Access Protocol (IMAP) and Post Office Protocol (POP) server, written primarily with security in mind
# depends       : libtirpc linuxpam

name=dovecot
version=2.4.0    
release=1
source="https://www.dovecot.org/releases/2.4/dovecot-$version.tar.gz"

options="!checksum"

build() {
    cd $name-$version
    
    ./configure --prefix=/usr                          \
    --sysconfdir=/etc                      \
    --localstatedir=/var                   \
    --with-systemd=no                      \
    --with-lua=no                          \
    --docdir=/usr/share/doc/dovecot-$version  \
    --disable-static 
    make
    groupadd -g 42 dovecot 
    useradd -c "Dovecot unprivileged user" -d /dev/null -u 42 \
    -g dovecot -s /bin/false dovecot 
    groupadd -g 43 dovenull 
    useradd -c "Dovecot login user" -d /dev/null -u 43 \
    -g dovenull -s /bin/false dovenull
    make DESTDIR=$PKG install
    mv -v /etc/dovecot/dovecot.conf{,.orig} 
    chmod -v 1777 /var/mail 
cat > $PKG/etc/dovecot/dovecot.conf << "EOF"
    # The dovecot configuration requires a minimum version to be set. The server
    # will refuse to start if the version set here is older than the version of
    # Dovecot installed. This option allows the Dovecot server to set reasonable
    # default values based on what version is set here.
    dovecot_config_version = $version
    # This option sets the minimum version that is able to read data files from
    # the Dovecot server. This is primarily for a cluster which may have several
    # different versions of Dovecot installed, but is required for the server to
    # run.
    dovecot_storage_version = $version
    protocols = imap
    ssl = no
    # The next line is only needed if you have no IPv6 network interfaces
    listen = *
    mail_inbox_path = /var/mail/%{user}
    mail_driver = mbox
    mail_path = ~/Mail
    userdb users {
    driver = passwd
}
passdb passwords {
driver = pam
}
EOF
cat > $PKG/etc/pam.d/dovecot << "EOF"
# Begin /etc/pam.d/dovecot
auth     include system-auth
account  include system-account
password include system-password
# End /etc/pam.d/dovecot
EOF
make DESTDIR=$PKG install-dovecot
}
