# description   : The Postfix package contains a Mail Transport Agent (MTA)
# depends       : cyrussasl libnsl lmdb

name=postfix
version=3.10.3    
release=1
source="https://ghostarchive.org/postfix/postfix-release/official/postfix-$version.tar.gz
https://anduin.linuxfromscratch.org/BLFS/bdb/db-5.3.28.tar.gz
https://anduin.linuxfromscratch.org/BLFS/bdb/db-5.3.28.tar.gz"

options="!checksum"

build() {
    cd $name-$version
    
    sed -i 's/.\x08//g' README_FILES/*
    CCARGS="-DNO_NIS -DNO_DB"
    AUXLIBS=""
    if [ -r /usr/lib/libsasl2.so ]; then
    CCARGS="$CCARGS -DUSE_SASL_AUTH -DUSE_CYRUS_SASL -I/usr/include/sasl"
    AUXLIBS="$AUXLIBS -lsasl2"
    fi
    if [ -r /usr/lib/liblmdb.so ]; then
    CCARGS="$CCARGS -DHAS_LMDB"
    AUXLIBS="$AUXLIBS -llmdb"
    fi
    if [ -r /usr/lib/libldap.so -a -r /usr/lib/liblber.so ]; then
    CCARGS="$CCARGS -DHAS_LDAP"
    AUXLIBS="$AUXLIBS -lldap -llber"
    fi
    if [ -r /usr/lib/libsqlite3.so ]; then
    CCARGS="$CCARGS -DHAS_SQLITE"
    AUXLIBS="$AUXLIBS -lsqlite3 -lpthread"
    fi
    if [ -r /usr/lib/libmysqlclient.so ]; then
    CCARGS="$CCARGS -DHAS_MYSQL -I/usr/include/mysql"
    AUXLIBS="$AUXLIBS -lmysqlclient -lz -lm"
    fi
    if [ -r /usr/lib/libpq.so ]; then
    CCARGS="$CCARGS -DHAS_PGSQL -I/usr/include/postgresql"
    AUXLIBS="$AUXLIBS -lpq -lz -lm"
    fi
    if [ -r /usr/lib/libssl.so -a -r /usr/lib/libcrypto.so ]; then
    CCARGS="$CCARGS -DUSE_TLS -I/usr/include/openssl/"
    AUXLIBS="$AUXLIBS -lssl -lcrypto"
    fi
    make DESTDIR=$PKG CC="gcc -std=gnu17" CCARGS="$CCARGS" AUXLIBS="$AUXLIBS" makefiles 
    make
    /usr/sbin/postfix -c /etc/postfix set-permissions
    /usr/sbin/postfix upgrade-configuration
    /usr/sbin/postfix check 
    /usr/sbin/postfix start
    groupadd -g 32 postfix 
    groupadd -g 33 postdrop 
    useradd -c "Postfix Daemon User" -d /var/spool/postfix -g postfix \
    -s /bin/false -u 32 postfix 
    chown -v postfix:postfix /var/mail
    sh postfix-install -non-interactive  \
    daemon_directory=/usr/lib/postfix \
    manpage_directory=/usr/share/man  \
    html_directory=/usr/share/doc/postfix-$version/html \
    readme_directory=/usr/share/doc/postfix-$version/readme
cat >> /etc/aliases << "EOF"
    # Begin /etc/aliases
    MAILER-DAEMON:    postmaster
    postmaster:       root
    root:             <em class="replaceable"><code><LOGIN></em>
    # End /etc/aliases</code>
EOF
    echo 'default_database_type = lmdb'       >> /etc/postfix/main.cf 
    echo 'alias_database = lmdb:/etc/aliases' >> /etc/postfix/main.cf 
    echo 'alias_maps = lmdb:/etc/aliases'     >> /etc/postfix/main.cf
    echo 'smtpd_forbid_bare_newline = normalize' >> /etc/postfix/main.cf 
    echo 'smtpd_forbid_bare_newline_exclusions = $mynetworks' >> /etc/postfix/main.cf
    make DESTDIR=$PKG install-postfix
}
