# description   : The sendmail package contains a Mail Transport Agent (MTA)
# depends       : openldap cyrussasl

name=sendmail
version=8.18.1    
release=1
source="https://ftp.sendmail.org/sendmail.$version.tar.gz
https://www.linuxfromscratch.org/patches/blfs/svn/sendmail-$version-gcc15_fixes-1.patch"

options="!checksum"

build() {
    cd $name-$version
    
    patch -Np1 -i ../sendmail-$version-gcc15_fixes-1.patch
cat >> devtools/Site/site.config.m4 << "EOF"
EOF
cat >> devtools/Site/site.config.m4 << "EOF"
EOF
    sed -i 's|/usr/man/man|/usr/share/man/man|' \
    devtools/OS/Linux           
    cd sendmail                     
    sh Build                        
    cd ../cf/cf                     
    cp generic-linux.mc sendmail.mc 
    sh Build sendmail.cf
    cd doc/op                                       
    sed -i 's/groff/GROFF_NO_SGR=1 groff/' Makefile 
    make DESTDIR=$PKG op.txt op.pdf
    groupadd -g 26 smmsp                               
    useradd -c "Sendmail Daemon" -g smmsp -d /dev/null \
    -s /bin/false -u 26 smmsp                  
    chmod -v 1777 /var/mail                            
    install -v -m700 -d /var/spool/mqueue
    install -v -d -m755 /etc/mail 
    sh Build install-cf 
    cd ../..            
    sh Build install    
    install -v -m644 cf/cf/{submit,sendmail}.mc /etc/mail 
    cp -v -R cf/* /etc/mail                               
    install -v -m755 -d /usr/share/doc/sendmail-$version/{cf,sendmail} 
    install -v -m644 CACerts FAQ KNOWNBUGS LICENSE PGPKEYS README RELEASE_NOTES \
    /usr/share/doc/sendmail-$version 
    install -v -m644 sendmail/{README,SECURITY,TRACEFLAGS,TUNING} \
    /usr/share/doc/sendmail-$version/sendmail 
    install -v -m644 cf/README /usr/share/doc/sendmail-$version/cf 
    for manpage in sendmail editmap mailstats makemap praliases smrsh
    do
    install -v -m644 $manpage/$manpage.8 /usr/share/man/man8
    done 
    install -v -m644 sendmail/aliases.5    /usr/share/man/man5 
    install -v -m644 sendmail/mailq.1      /usr/share/man/man1 
    install -v -m644 sendmail/newaliases.1 /usr/share/man/man1 
    install -v -m644 vacation/vacation.1   /usr/share/man/man1
    install -v -d -m755 /usr/share/doc/sendmail-$version 
    install -v -m644 op.ps op.txt op.pdf /usr/share/doc/sendmail-$version 
    cd ../..
    echo $(hostname) > /etc/mail/local-host-names
cat > $PKG/etc/mail/aliases << "EOF"
    postmaster: root
    MAILER-DAEMON: root
EOF
    # Does not work if there is no database backend compiled in:
    #newaliases
    cd /etc/mail 
    m4 m4/cf.m4 sendmail.mc > sendmail.cf
    make DESTDIR=$PKG install-sendmail
}
