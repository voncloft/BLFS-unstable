# description   : No description available
# depends       : boost ffmpeg gtk kde frameworks kirigamiaddons libdisplayinfo libpwquality libqalculate libnl libxcvt libxkbcommon mesa wayland opencv phonon pipewire pulseaudioqt qca qcoro sassc taglib xdotool xorgevdevdriver gsettingsdesktopschemas libcanberra libinput libpcap libwacom xorgwacomdriver linuxpam lmsensors362 oxygenicons pciutils powerprofilesdaemon psutil pygdbmi sentrysdk urllib3 accountsservice breezeicons kioextras smartmontools xdgdesktopportal xwayland

name=building plasma
version=
release=1
source=""

options="!checksum"

build() {
    cd $name-$version
    
    url=https://download.kde.org/stable/plasma/6.3.4/
    wget -r -nH -nd -A '*.xz' -np $url
cat > $PKGplasma-6.3.4.md5 << "EOF"
EOF
    as_root()
    {
    if   [ $EUID = 0 ];        then $*
    elif [ -x /usr/bin/sudo ]; then sudo $*
    else                            su -c \\"$*\\"
    fi
}
export -f as_root
bash -e
while read -r line; do
# Get the file name, ignoring comments and blank lines
if $(echo $line | grep -E -q '^ *$|^#' ); then continue; fi
file=$(echo $line | cut -d" " -f2)
pkg=$(       echo $file|sed 's|^.*/||')    # Remove directory
name=$(      echo $pkg |sed 's|-6.*$||')   # Isolate package name
packagedir=$(echo $pkg |sed 's|\.tar.*||') # Source directory
tar -xf $file
pushd $packagedir
# Fix some build issues with qt-6.9.0 and later
case $name in
breeze)
sed -e '/QList/i #include <QDebug>' \
-i cursors/src/kcursorgen/kcursorgen.h
;;
plasma-vault)
sed -e '/QFuture/i #include <QDebug>' \
-i kded/engine/commandresult.h
;;
esac
mkdir build
cd    build
cmake -D CMAKE_INSTALL_PREFIX=$KF6_PREFIX \
-D CMAKE_INSTALL_LIBEXECDIR=libexec \
-D CMAKE_BUILD_TYPE=Release         \
-D BUILD_QT5=OFF                    \
-D BUILD_TESTING=OFF                \
-W no-dev ..  
make
as_root make install
popd
as_root rm -rf $packagedir
as_root /sbin/ldconfig
done < plasma-6.3.4.md5
exit
cat > $PKG~/.xinitrc << "EOF"
EOF
startx
startx > ~/x-session-errors
# Setup xsessions (X11 sessions)
install -dvm 755 /usr/share/xsessions
cd /usr/share/xsessions
[ -e plasma.desktop ] ||
ln -sfv $KF6_PREFIX/share/xsessions/plasmax11.desktop
# Setup wayland-sessions
install -dvm 755 /usr/share/wayland-sessions
cd /usr/share/wayland-sessions
[ -e plasmawayland.desktop ] ||
ln -sfv $KF6_PREFIX/share/wayland-sessions/plasma.desktop
# Setup xdg-desktop-portal
install -dvm 755 /usr/share/xdg-desktop-portal
cd /usr/share/xdg-desktop-portal
[ -e kde-portals.conf ] ||
ln -sfv $KF6_PREFIX/share/xdg-desktop-portal/kde-portals.conf
# Setup kde portal
install -dvm 755 /usr/share/xdg-desktop-portal/portals
cd /usr/share/xdg-desktop-portal/portals
[ -e kde.portal ] ||
ln -sfv $KF6_PREFIX/share/xdg-desktop-portal/portals/kde.portal
rm -rf $KF6_PREFIX/lib/systemd
cat > $PKG/etc/pam.d/kde << "EOF"
# Begin /etc/pam.d/kde
auth     requisite      pam_nologin.so
auth     required       pam_env.so
auth     required       pam_succeed_if.so uid >= 1000 quiet
auth     include        system-auth
account  include        system-account
password include        system-password
session  include        system-session
# End /etc/pam.d/kde
EOF
cat > $PKG/etc/pam.d/kde-np << "EOF"
# Begin /etc/pam.d/kde-np
auth     requisite      pam_nologin.so
auth     required       pam_env.so
auth     required       pam_succeed_if.so uid >= 1000 quiet
auth     required       pam_permit.so
account  include        system-account
password include        system-password
session  include        system-session
# End /etc/pam.d/kde-np
EOF
cat > $PKG/etc/pam.d/kscreensaver << "EOF"
# Begin /etc/pam.d/kscreensaver
auth    include system-auth
account include system-account
# End /etc/pam.d/kscreensaver
EOF
}
